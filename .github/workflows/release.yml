name: Release

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build-and-upload:
    name: Build and Upload
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Derive version from tag
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Import signing certificate
        env:
          P12_BASE64: ${{ secrets.DEVELOPER_ID_P12 }}
          P12_PASSWORD: ${{ secrets.DEVELOPER_ID_P12_PASSWORD }}
        run: |
          CERTIFICATE_PATH="$RUNNER_TEMP/certificate.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 24)"

          echo -n "$P12_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$CERTIFICATE_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$P12_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security set-key-partition-list -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

      - name: Build
        run: |
          xcodebuild build \
            -project BreatheBar.xcodeproj \
            -scheme BreatheBar \
            -configuration Release \
            -derivedDataPath build \
            MARKETING_VERSION="$VERSION" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Developer ID Application: Nevyn Bengtsson (M4Q2TE45WT)" \
            DEVELOPMENT_TEAM=M4Q2TE45WT \
            OTHER_CODE_SIGN_FLAGS=--timestamp \
            CODE_SIGN_INJECT_BASE_ENTITLEMENTS=NO

      - name: Verify code signature
        run: |
          echo "--- Signature info ---"
          codesign -dvv build/Build/Products/Release/BreatheBar.app
          echo ""
          echo "--- Signature verification ---"
          codesign --verify --deep --strict --verbose=2 \
            build/Build/Products/Release/BreatheBar.app

      - name: Create zip
        run: |
          ditto -c -k --keepParent \
            build/Build/Products/Release/BreatheBar.app \
            "BreatheBar_${VERSION}.zip"

      - name: Notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: M4Q2TE45WT
        run: |
          SUBMIT_OUTPUT=$(xcrun notarytool submit "BreatheBar_${VERSION}.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait \
            --output-format json)

          echo "$SUBMIT_OUTPUT"

          STATUS=$(echo "$SUBMIT_OUTPUT" | python3 -c "import sys,json; print(json.load(sys.stdin)['status'])")
          SUBMISSION_ID=$(echo "$SUBMIT_OUTPUT" | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")

          if [ "$STATUS" != "Accepted" ]; then
            echo ""
            echo "::error::Notarization failed with status: $STATUS"
            echo ""
            echo "--- Notarization log ---"
            xcrun notarytool log "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_ID_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" || true
            exit 1
          fi

          xcrun stapler staple \
            build/Build/Products/Release/BreatheBar.app

          ditto -c -k --keepParent \
            build/Build/Products/Release/BreatheBar.app \
            "BreatheBar_${VERSION}.zip"

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "${{ github.event.release.tag_name }}" \
            "BreatheBar_${VERSION}.zip" \
            --clobber

      - name: Clean up
        if: always()
        run: |
          security delete-keychain "$RUNNER_TEMP/signing.keychain-db" 2>/dev/null || true
          rm -f "$RUNNER_TEMP/certificate.p12"
